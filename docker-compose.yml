
services:
  # Database Service
  mysqldb:
    image: mysql:8.0
    container_name: crm-mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: crm_db
    ports:
      # Exposes the database on port 3307 on the host to avoid conflicts
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - crm-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

  # Backend Service (Spring Boot)
  backend:
    # Pulls the backend image from Docker Hub, built by GitHub Actions
    image: gowthamsaikorada/crm-backend:latest
    container_name: crm-backend
    ports:
      - "2025:2020"
    environment:
      # Connects to the database using the service name 'mysqldb'
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysqldb:3306/crm_db?useSSL=false
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      mysqldb:
        condition: service_healthy
    networks:
      - crm-network
    restart: on-failure

  # Frontend Service (React)
  frontend:
    # Pulls the frontend image from Docker Hub, built by GitHub Actions
    image: gowthamsaikorada/crm-frontend:latest
    container_name: crm-frontend
    ports:
      - "4000:80"
    depends_on:
      - backend
    networks:
      - crm-network
    restart: on-failure

# Named volume for persistent database storage
volumes:
  mysql_data:

# Bridge network for services to communicate with each other
networks:
  crm-network:
    driver: bridge
